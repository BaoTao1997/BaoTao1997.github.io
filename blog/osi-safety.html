<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Web安全 | BaoTao的前端日志</title>
    <meta name="description" content="欢迎访问我的前端日志">
    <link rel="icon" href="/hero.png">
    
    <link rel="preload" href="/assets/css/0.styles.1a992bd3.css" as="style"><link rel="preload" href="/assets/js/app.f225858c.js" as="script"><link rel="preload" href="/assets/js/2.672550d7.js" as="script"><link rel="preload" href="/assets/js/37.6ea9bf2e.js" as="script"><link rel="prefetch" href="/assets/js/10.c2729db0.js"><link rel="prefetch" href="/assets/js/11.6652c16a.js"><link rel="prefetch" href="/assets/js/12.c99151b5.js"><link rel="prefetch" href="/assets/js/13.c20a05a6.js"><link rel="prefetch" href="/assets/js/14.1ef90bc5.js"><link rel="prefetch" href="/assets/js/15.48e33afe.js"><link rel="prefetch" href="/assets/js/16.9480cdd8.js"><link rel="prefetch" href="/assets/js/17.2dbe7a92.js"><link rel="prefetch" href="/assets/js/18.d2ff3f51.js"><link rel="prefetch" href="/assets/js/19.bad3ad9a.js"><link rel="prefetch" href="/assets/js/20.f54ae634.js"><link rel="prefetch" href="/assets/js/21.fad4d162.js"><link rel="prefetch" href="/assets/js/22.8ce49b77.js"><link rel="prefetch" href="/assets/js/23.191fcec1.js"><link rel="prefetch" href="/assets/js/24.5d911dd7.js"><link rel="prefetch" href="/assets/js/25.92e6ee1b.js"><link rel="prefetch" href="/assets/js/26.2e6ac599.js"><link rel="prefetch" href="/assets/js/27.771ef2ee.js"><link rel="prefetch" href="/assets/js/28.9ddf0721.js"><link rel="prefetch" href="/assets/js/29.3deeede2.js"><link rel="prefetch" href="/assets/js/3.5f2ab74c.js"><link rel="prefetch" href="/assets/js/30.fe8bff52.js"><link rel="prefetch" href="/assets/js/31.1858abcd.js"><link rel="prefetch" href="/assets/js/32.bfb29c32.js"><link rel="prefetch" href="/assets/js/33.a2ae8076.js"><link rel="prefetch" href="/assets/js/34.531e6b81.js"><link rel="prefetch" href="/assets/js/35.645bc314.js"><link rel="prefetch" href="/assets/js/36.56d7c6c2.js"><link rel="prefetch" href="/assets/js/38.2c569e14.js"><link rel="prefetch" href="/assets/js/39.0fbb6fc9.js"><link rel="prefetch" href="/assets/js/4.43a614f9.js"><link rel="prefetch" href="/assets/js/40.a2e40f8e.js"><link rel="prefetch" href="/assets/js/41.8de6a957.js"><link rel="prefetch" href="/assets/js/42.f34c83ed.js"><link rel="prefetch" href="/assets/js/43.5124ce0a.js"><link rel="prefetch" href="/assets/js/44.5148b76a.js"><link rel="prefetch" href="/assets/js/45.0482d6c2.js"><link rel="prefetch" href="/assets/js/46.dca6e042.js"><link rel="prefetch" href="/assets/js/47.d3d60350.js"><link rel="prefetch" href="/assets/js/48.c5d4232b.js"><link rel="prefetch" href="/assets/js/49.23efdb3a.js"><link rel="prefetch" href="/assets/js/5.c06abc86.js"><link rel="prefetch" href="/assets/js/50.143a9543.js"><link rel="prefetch" href="/assets/js/51.67b5b689.js"><link rel="prefetch" href="/assets/js/52.0a3fb16a.js"><link rel="prefetch" href="/assets/js/6.13d9ab35.js"><link rel="prefetch" href="/assets/js/7.d11a37f8.js"><link rel="prefetch" href="/assets/js/8.69f4770c.js"><link rel="prefetch" href="/assets/js/9.3a968c29.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1a992bd3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">BaoTao的前端日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试题</a></div><div class="nav-item"><a href="/book/" class="nav-link">阅读</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="/resume/" class="nav-link">简历</a></div> <a href="https://github.com/BaoTao1997" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试题</a></div><div class="nav-item"><a href="/book/" class="nav-link">阅读</a></div><div class="nav-item"><a href="/project/" class="nav-link">项目</a></div><div class="nav-item"><a href="/resume/" class="nav-link">简历</a></div> <a href="https://github.com/BaoTao1997" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端工程化与设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/engineering-optimize.html" class="sidebar-link">web性能优化</a></li><li><a href="/blog/pattern-pub_sub.html" class="sidebar-link">订阅发布模式和EventEmitter</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Framework</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/framework-mvvm.html" class="sidebar-link">动手实现一个简单的MVVM</a></li><li><a href="/blog/framework-vue_curd.html" class="sidebar-link">Vue的增删改查</a></li><li><a href="/blog/framework-vue-lazyload.html" class="sidebar-link">从Vue-lazyload看图片懒加载</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>网络协议</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/osi-tcp.html" class="sidebar-link">TCP连接</a></li><li><a href="/blog/osi-status_code.html" class="sidebar-link">HTTP状态码解析</a></li><li><a href="/blog/osi-http_header.html" class="sidebar-link">HTTP报文解析</a></li><li><a href="/blog/osi-safety.html" class="active sidebar-link">Web安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#xss" class="sidebar-link">XSS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#例子" class="sidebar-link">例子</a></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#类型" class="sidebar-link">类型</a></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#html内容" class="sidebar-link">HTML内容</a></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#html属性" class="sidebar-link">HTML属性</a></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#javascript-代码" class="sidebar-link">Javascript 代码</a></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#富文本" class="sidebar-link">富文本</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#csrf" class="sidebar-link">CSRF</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#禁止第三方网站带cookies" class="sidebar-link">禁止第三方网站带Cookies</a></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#不访问a网站的前端" class="sidebar-link">不访问A网站的前端</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#cookies" class="sidebar-link">Cookies</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#已登录用户凭证" class="sidebar-link">已登录用户凭证</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#点击劫持" class="sidebar-link">点击劫持</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#通过js禁止内嵌" class="sidebar-link">通过JS禁止内嵌</a></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#通过http头禁止内嵌" class="sidebar-link">通过HTTP头禁止内嵌</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#http明文协议" class="sidebar-link">HTTP明文协议</a></li><li class="sidebar-sub-header"><a href="/blog/osi-safety.html#密码安全" class="sidebar-link">密码安全</a></li></ul></li><li><a href="/blog/osi-login.html" class="sidebar-link">Web登录鉴权</a></li><li><a href="/blog/osi-cache.html" class="sidebar-link">浏览器缓存策略</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/data-structure-sort.html" class="sidebar-link">排序算法</a></li><li><a href="/blog/data-structure-binarytree.html" class="sidebar-link">二叉树</a></li><li><a href="/blog/data-structure-linkList.html" class="sidebar-link">链表</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/css-repaint.html" class="sidebar-link">CSS的repaint和reflow</a></li><li><a href="/blog/css-self-adaption.html" class="sidebar-link">CSS自适应</a></li><li><a href="/blog/css-tips.html" class="sidebar-link">CSS技巧</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/js-regex.html" class="sidebar-link">正则表达式</a></li><li><a href="/blog/js-prototype.html" class="sidebar-link">JS原型链与原型</a></li><li><a href="/blog/js-promise.html" class="sidebar-link">手写符合Promise/A+的Promise</a></li><li><a href="/blog/js-eventloop.html" class="sidebar-link">JS事件循环</a></li><li><a href="/blog/js-typescript.html" class="sidebar-link">TypeScript 在Vue项目中的使用总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>运维与多人协作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/operation-git.html" class="sidebar-link">Git常规操作与Linux命令</a></li><li><a href="/blog/operation-blog.html" class="sidebar-link">搭建持续集成的个人博客</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="web安全"><a href="#web安全" aria-hidden="true" class="header-anchor">#</a> Web安全</h1> <p>本文将会针对前端一些常见的网络攻击方式，以及Cookies做一些讲解。</p> <h2 id="xss"><a href="#xss" aria-hidden="true" class="header-anchor">#</a> XSS</h2> <h3 id="例子"><a href="#例子" aria-hidden="true" class="header-anchor">#</a> 例子</h3> <p>输入网址，通过在url参数中添加js脚本实现xss攻击，这会被用来<strong>获取页面上的数据</strong>，<strong>获取Cookie</strong>，<strong>劫持前端逻辑</strong>，<strong>发送请求</strong>（通过<code>&lt;img src=''&gt;</code>src指向自己的PHP脚本执行逻辑）</p> <h3 id="类型"><a href="#类型" aria-hidden="true" class="header-anchor">#</a> 类型</h3> <p>反射型XSS：攻击者提前构造一个恶意链接，来诱使客户点击，比如这样的一段链接：<code>www.abc.com/?params=&lt;script&gt;alert(/xss/)&lt;/script&gt;</code></p> <p>存储型XSS：攻击者在论坛的楼层中包含了一段JavaScript代码，并且服务器没有正确进行过滤输出，那就会造成浏览这个页面的用户执行这段JavaScript代码（评论列表）</p> <p>DOM型XSS：利用非法输入来闭合对应的html标签</p> <h3 id="html内容"><a href="#html内容" aria-hidden="true" class="header-anchor">#</a> HTML内容</h3> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    #{content}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们需要对<code>&lt;</code>和<code>&gt;</code>进行转义，保证其不会执行</p> <h3 id="html属性"><a href="#html属性" aria-hidden="true" class="header-anchor">#</a> HTML属性</h3> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#{image}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>alert(1)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> // 提前添加“或者‘使得src属性闭合，执行别的逻辑
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们需要转义单引号和双引号，我们这个和上面的转义并不冲突，所以可以放在一起，记住转义为HTML实体都有<code>&amp;</code>，所以我们需要先对<code>&amp;</code>进行转义，再进行其他转义,代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">escapeHtml</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>str<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&amp;/g</span><span class="token punctuation">,</span> <span class="token string">'&amp;amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;/g</span><span class="token punctuation">,</span> <span class="token string">'&amp;lt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&gt;/g</span><span class="token punctuation">,</span> <span class="token string">'&amp;gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&quot;/g</span><span class="token punctuation">,</span> <span class="token string">'&amp;quto;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/'/g</span><span class="token punctuation">,</span> <span class="token string">'&amp;#39;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> str<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>注意：浏览器本身有自带的防御措施，ctx.set('X-XSS-Protection', 0); 设为0会关闭，默认值为1则打开，可以防止url参数出现HTML属性和内容，不过防范还是很有限，只能阻止HTML内容。</p></blockquote> <h3 id="javascript-代码"><a href="#javascript-代码" aria-hidden="true" class="header-anchor">#</a> Javascript 代码</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">&quot;#{data}&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>产生原因也是因为双引号，对此也可以采用转义的方式，但是这会导致代码出现不需要的<code>\\</code>。如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">escapeForJs</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>str<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
    str <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&quot;/g</span><span class="token punctuation">,</span> <span class="token string">'\\&quot;'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>所以我们可以采用<code>JSON.stringfy()</code>来进行转义。</p> <h3 id="富文本"><a href="#富文本" aria-hidden="true" class="header-anchor">#</a> 富文本</h3> <p>特点：<strong>需要保留HTML，但HTML有XSS风险</strong></p> <h4 id="黑名单"><a href="#黑名单" aria-hidden="true" class="header-anchor">#</a> 黑名单</h4> <p>黑名单是禁止某些HTML内容，问题在于HTMl标签体系繁多，很容易出现漏洞：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">xssFliter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>html<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/&lt;\s*\?script\s*&gt;/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 防止&lt;script&gt;标签</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/javascript:[^'&quot;]*/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//防止a标签的herf属性的javascript：</span>
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/onerror\s*=\s*['&quot;]?[^'&quot;]*['&quot;]?/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 防止onerror事件</span>
    <span class="token keyword">return</span> html
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="白名单"><a href="#白名单" aria-hidden="true" class="header-anchor">#</a> 白名单</h4> <p>所以大部分时候是采用，白名单的方式，可以使用<a href="https://github.com/cheeriojs/cheerio" target="_blank" rel="noopener noreferrer">cheerio<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或者<a href="https://github.com/leizongmin/js-xss" target="_blank" rel="noopener noreferrer">js-xss<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，配置那些HTML内容可以执行，是需要自己可控，还是想快速简单，可以按照场景进行选择。下面是<a href="https://github.com/cheeriojs/cheerio" target="_blank" rel="noopener noreferrer">cheerio<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的使用方式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> whiteList <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'img'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'font'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'color'</span><span class="token punctuation">,</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'herf'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">froEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span>item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>whiteList<span class="token punctuation">[</span>item<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> attr <span class="token keyword">in</span> item<span class="token punctuation">.</span>attribs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>whiteList<span class="token punctuation">[</span>item<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//不是白名单中的属性则去除</span>
            <span class="token function">$</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="csp"><a href="#csp" aria-hidden="true" class="header-anchor">#</a> CSP</h4> <p>要启用CSP，您需要配置Web服务器以返回<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy" target="_blank" rel="noopener noreferrer"><code>Content-Security-Policy</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>HTTP标头（有时您会看到<code>X-Content-Security-Policy</code>标题的提及，但这是旧版本，您不再需要指定它）。</p> <p>例如：<code>&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src 'self'; img-src *; media-src media1.com media2.com; script-src userscripts.example.com&quot;&gt;</code></p> <p>此处，默认情况下，仅允许来自文档来源的内容，但以下情况除外：</p> <p>图像可以从任何地方加载（请注意“*”通配符）。
媒体仅允许来自media1.com和media2.com（而不是来自这些网站的子域）。
只允许来自userscripts.example.com的可执行脚本。</p> <p>具体内容可以参考<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank" rel="noopener noreferrer">CSP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="csrf"><a href="#csrf" aria-hidden="true" class="header-anchor">#</a> CSRF</h2> <p>CSRF攻击原理：</p> <ol><li>用户登录A网站</li> <li>A网站确认身份</li> <li>B网站页面向A网站发起请求（带A网站的身份）</li></ol> <h3 id="禁止第三方网站带cookies"><a href="#禁止第三方网站带cookies" aria-hidden="true" class="header-anchor">#</a> 禁止第三方网站带Cookies</h3> <p>CSRF攻击需要携带用户的Cookies来通过验证，采用<code>SameSite</code>属性即可实现阻止Cookies被第三方网站使用，在<code>node.js</code>中可以采用如下形式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'userId'</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
   sameSite<span class="token punctuation">:</span> <span class="token string">'strict'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>不过这个<a href="https://www.caniuse.com/#search=SameSite" target="_blank" rel="noopener noreferrer">属性的支持程度不高<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，所以只能作为辅助办法。</p> <h3 id="不访问a网站的前端"><a href="#不访问a网站的前端" aria-hidden="true" class="header-anchor">#</a> 不访问A网站的前端</h3> <p>由于CSRF攻击不会访问A网站的前端，我们可以在前端加入验证信息，目前有两种方式：</p> <h4 id="验证码"><a href="#验证码" aria-hidden="true" class="header-anchor">#</a> 验证码</h4> <p>我们可以使用npm上的<a href="https://www.npmjs.com/package/ccap" target="_blank" rel="noopener noreferrer">ccap<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，具体使用方式如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> captcha <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
captcha<span class="token punctuation">.</span><span class="token function-variable function">captcha</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ccap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ccap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> capt <span class="token operator">=</span> <span class="token function">ccap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> capt<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    captcha<span class="token punctuation">.</span><span class="token function">setCache</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'userId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// data[0]为验证码数字</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//data[1]为验证码图片</span>
<span class="token punctuation">}</span>
captcha<span class="token punctuation">.</span><span class="token function-variable function">setCache</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">uid<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//访问页面时设置验证码</span>
    cache<span class="token punctuation">[</span>uid<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
captcha<span class="token punctuation">.</span><span class="token function-variable function">validCache</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">uid<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">//CSRF攻击是验证码是空的，正常页面用户会输入验证码通过表单提交与后台存储的进行比对验证</span>
    <span class="token keyword">return</span> cache<span class="token punctuation">[</span>uid<span class="token punctuation">]</span> <span class="token operator">===</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> captcha<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在添加评论的模块中引入，在前端添加一个输入验证码的input框<code>&lt;input name=&quot;captcha&quot; placeholder=&quot;验证码&quot; /&gt;&lt;img src=&quot;/captcha&quot;&gt;</code>注意要判断<strong>验证码为空</strong>的情况：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">.</span>captcha<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'验证码错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> captcha <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'captcha'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//引入上面的captcha文件</span>
<span class="token keyword">var</span> captchaResult <span class="token operator">=</span> captcha<span class="token punctuation">.</span><span class="token function">validCache</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'useId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>captcha<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>captchaResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'验证码错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="token"><a href="#token" aria-hidden="true" class="header-anchor">#</a> token</h4> <p>后端生成一个随机的token，需要放到两个地方：1. 放到页面的表单中(<em>使用一个隐藏的input框</em>） 2. 放到浏览器的Cookies中(<em>或者后端的session中</em>)。</p> <p>用户添加评论时，会把表单中Token与Cookies的Token进行比对(<em>如果是存在session中，则与session进行比对</em>)，由于CSRF无法获取到原网站页面上的Token，同时无法改变Cookies的Token(通过设置<strong>HttpOnly</strong>属性)，所以无法通过。</p> <p>如果你是Ajax请求的话，可以使用<code>&lt;meta name=&quot;csrf_token&quot; content=&quot;csrfToken&quot;&gt;</code>，通过Ajax请求时通过JS获取meta中的值。</p> <p>如果用户打开多个页面的话，其他的页面的token失效，因为每次都会生成一个随机的token，只有最后一个页面能够成功。</p> <h4 id="referer"><a href="#referer" aria-hidden="true" class="header-anchor">#</a> referer</h4> <p>通过<code>referer</code>请求头来判断请求的域名是否是合法的，如果不是则抛出错误</p> <h2 id="cookies"><a href="#cookies" aria-hidden="true" class="header-anchor">#</a> Cookies</h2> <p>特点</p> <ul><li>前端数据存储，后端通过HTTP头设置，请求时通过HTTP头传给后端，前端可读写，遵守同源策略</li></ul> <p>特性</p> <ul><li>域名(domain)，有效期(expires)，路径(path)，http-only(不能通过js获取)，secure(只能在https中使用)，sameSite(禁止第三方的Cookies)</li> <li>每次设置Cookie时最好用<code>encodeURIComponent</code>编码，获取时用<code>decodeUPIComponent</code>解码</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">'a=111;'</span> <span class="token comment">// 只是添加Cookies</span>
<span class="token keyword">var</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token template-string"><span class="token string">`a=111; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>now<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span> <span class="token comment">// 只能通过设置expires删除Cookie</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>作用</p> <ul><li>存储个性化设置，未登录时唯一标识，已登录用户凭证，其他相关业务数据</li></ul> <h3 id="已登录用户凭证"><a href="#已登录用户凭证" aria-hidden="true" class="header-anchor">#</a> 已登录用户凭证</h3> <p>直接使用用户名作为登录凭证，存在很大的问题不讨论</p> <p>将用户名，和通过签名算法加密的用户名作为登录凭证(<em>不可逆算法</em>)，后端也对用户名采用同样的算法加密进行比对判断是否为同一用户</p> <p>SessionId：把sessionid写入到Cookies中，将用户信息存入到服务端(<em>一般会采用外部存储Redis</em>)</p> <p>Token：采用JWT实现,当用户登录时，后端生成一个Token返回前端，前端可以把Token存储到Cookies或者<code>LocalStorage</code>中，当用户访问认证的接口时可以在<strong>URL 参数</strong>或 <strong>HTTP Header</strong> 中加入 Token，后端解析Token实现用户的登录鉴权。</p> <p>而 JWT 的最大优势是服务端不再需要存储 Session，使得服务端认证鉴权业务可以方便扩展，避免存储 Session 所需要引入的 Redis 等组件，降低了系统架构复杂度。</p> <p>但这也是 JWT 最大的劣势，由于有效期存储在 Token 中，JWT Token 一旦签发，就会在有效期内一直可用，无法在服务端废止，当用户进行登出操作，只能依赖客户端删除掉本地存储的 JWT Token，如果需要禁用用户，单纯使用 JWT 就无法做到了。</p> <h4 id="token禁用用户"><a href="#token禁用用户" aria-hidden="true" class="header-anchor">#</a> Token禁用用户</h4> <p>Access Token也就是访问资源接口时所需要的 Token，还有另外一种 Token，Refresh Token，通常情况下，Refresh Token 的有效期会比较长(<em>7天左右</em>)，而 Access Token 的有效期比较短(<em>10分钟左右</em>)，当 Access Token 由于过期而失效时，使用 Refresh Token 就可以获取到新的 Access Token，如果 Refresh Token 也失效了，用户就只能重新登录了。</p> <p><strong>将生成的 Refresh Token 以及过期时间存储在服务端的数据库中</strong>，由于 Refresh Token 不会在客户端请求业务接口时验证，只有在申请新的 Access Token 时才会验证，所以将 Refresh Token 存储在数据库中，不会对业务接口的响应时间造成影响，也不需要像 Session 一样一直保持在内存中以应对大量的请求。</p> <h2 id="点击劫持"><a href="#点击劫持" aria-hidden="true" class="header-anchor">#</a> 点击劫持</h2> <p>使用<code>&lt;iframe&gt;</code>标签把网站嵌入到页面中，设置透明度为0，在外部覆盖一层图片监听点击事件来发送请求，导致<strong>点击劫持</strong>。</p> <h3 id="通过js禁止内嵌"><a href="#通过js禁止内嵌" aria-hidden="true" class="header-anchor">#</a> 通过JS禁止内嵌</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span>top<span class="token punctuation">.</span>location <span class="token operator">!==</span> window<span class="token punctuation">.</span>location<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    top<span class="token punctuation">.</span>location <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">;</span> <span class="token comment">// 实现跳出该劫持网页</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="通过http头禁止内嵌"><a href="#通过http头禁止内嵌" aria-hidden="true" class="header-anchor">#</a> 通过HTTP头禁止内嵌</h3> <p>因为可以在<code>&lt;iframe&gt;</code>中禁止使用JS（利用<code>sandbox</code>属性），所以可以使用<code>X-Frame-Options</code>设为<code>DENY</code>，禁止页面被嵌入<code>&lt;iframe&gt;</code>。</p> <h2 id="http明文协议"><a href="#http明文协议" aria-hidden="true" class="header-anchor">#</a> HTTP明文协议</h2> <p>HTTP篡改</p> <ul><li>运营商劫持，局域网代理劫持，公共WIFI获取密码</li></ul> <p>采用HTTPS并进行部署</p> <ul><li>在<a href="https://www.sslforfree.com/" target="_blank" rel="noopener noreferrer">SSL For Free<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>申请证书，使用人工DNS查询保证网站的存在</li> <li>下载证书包含CA证书，自己的证书以及私钥</li> <li>Node使用HTTPS包开启HTTPS服务，并传入Key和Cert(一个文件，把自己的证书和CA证书--放后面)</li> <li>部署成功后用<strong>AnyProxy</strong>进行代理，会发现HTTPS会用CONNECT建立一个通道，代理是查看不到内容的</li></ul> <h2 id="密码安全"><a href="#密码安全" aria-hidden="true" class="header-anchor">#</a> 密码安全</h2> <p>Hash算法</p> <ul><li>一一对应，单向的（无法通过密文得到明文），固定长度，只要有一点修改就会完全不一样</li> <li>有MD5，sha1，sha256这几种加密方式</li></ul> <p>由于<a href="https://baike.baidu.com/item/%E5%BD%A9%E8%99%B9%E8%A1%A8/689313?fr=aladdin" target="_blank" rel="noopener noreferrer">彩虹表<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的存在，实际项目中需要通过把<strong>用户输入的密码加<code>salt</code>（随机尽量长的字符串），然后使用多次Hash算法就可以实现</strong></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/BaoTao1997/edit/master/docs/blog/osi-safety.md" target="_blank" rel="noopener noreferrer">帮助我完善这篇内容🙏</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新时间: </span> <span class="time">8/6/2019, 10:57:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/osi-http_header.html" class="prev">
          HTTP报文解析
        </a></span> <span class="next"><a href="/blog/osi-login.html">
          Web登录鉴权
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f225858c.js" defer></script><script src="/assets/js/2.672550d7.js" defer></script><script src="/assets/js/37.6ea9bf2e.js" defer></script>
  </body>
</html>
